// src/App.tsx
import { useState, useEffect } from "react";

interface TimetableEvent {
  moduleName: string;
  room: string;
  day: string;
  start: string;
  end: string;
}

export default function App() {
  const [programmes, setProgrammes] = useState<{ id: string; name: string }[]>([]);
  const [selectedProgramme, setSelectedProgramme] = useState("");
  const [events, setEvents] = useState<TimetableEvent[]>([]);

  // Load programmes (Programmes of Study dropdown)
  useEffect(() => {
    fetch("https://timetables.tudublin.ie/api/programmesofstudy") // endpoint TU Dublin uses
      .then((res) => res.json())
      .then((data) => {
        setProgrammes(data);
      })
      .catch((err) => console.error("Failed to fetch programmes", err));
  }, []);

  // Load timetable events when programme changes
  useEffect(() => {
    if (!selectedProgramme) return;
    fetch(
      `https://timetables.tudublin.ie/api/timetables?searchText=${selectedProgramme}&view=week`
    )
      .then((res) => res.json())
      .then((data) => {
        // Map API data to our format
        const mapped = data.events.map((e: any) => ({
          moduleName: e.module,
          room: e.room,
          day: e.day,
          start: e.startTime,
          end: e.endTime,
        }));
        setEvents(mapped);
      })
      .catch((err) => console.error("Failed to fetch timetable", err));
  }, [selectedProgramme]);

  const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-4">TU Dublin Timetable Viewer</h1>

      <select
        className="border p-2 rounded mb-6"
        onChange={(e) => setSelectedProgramme(e.target.value)}
        value={selectedProgramme}
      >
        <option value="">Select Programme of Study</option>
        {programmes.map((p) => (
          <option key={p.id} value={p.name}>
            {p.name}
          </option>
        ))}
      </select>

      <div className="grid grid-cols-5 gap-4">
        {days.map((day) => (
          <div key={day} className="border rounded p-2">
            <h2 className="font-semibold text-lg mb-2">{day}</h2>
            <ul className="space-y-2">
              {events
                .filter((ev) => ev.day === day)
                .map((ev, i) => (
                  <li
                    key={i}
                    className="p-2 rounded bg-blue-100 shadow-sm text-sm"
                  >
                    <div className="font-medium">{ev.moduleName}</div>
                    <div>
                      {ev.start} - {ev.end}
                    </div>
                    <div className="text-gray-600">{ev.room}</div>
                  </li>
                ))}
            </ul>
          </div>
        ))}
      </div>
    </div>
  );
}
